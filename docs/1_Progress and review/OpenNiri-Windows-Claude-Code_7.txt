
╭─── Claude Code v2.1.29 ─────────────────────────────────────────────────────────────────────────────────╮
│                                         │ Tips for getting started                                      │
│           Welcome back Stark!           │ Run /init to create a CLAUDE.md file with instructions for C… │
│                                         │ ───────────────────────────────────────────────────────────── │
│                                         │ Recent activity                                               │
│                 ▐▛███▜▌                 │ No recent activity                                            │
│                ▝▜█████▛▘                │                                                               │
│                  ▘▘ ▝▝                  │                                                               │
│   Opus 4.5 · Claude Max · Stark Burns   │                                                               │
│         C:\dev\OpenNiri-Windows         │                                                               │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯

╭─────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                                                       │
│                                                                                                         │
│ Code Review Cycle 7 - OpenNiri Core Layout Engine                                                       │
│                                                                                                         │
│ PHASE 1: DEEP ANALYSIS & BLUEPRINT                                                                      │
│                                                                                                         │
│ 1.1 Goal Definition                                                                                     │
│                                                                                                         │
│ Success Criteria: Fix remaining arithmetic safety issues, add high-value API methods, and expand test   │
│ coverage to 50+ tests. All changes must maintain backward compatibility and pass comprehensive testing. │
│                                                                                                         │
│ 1.2 Context & Reconnaissance                                                                            │
│ ┌─────────────────┬───────────────────────────────────────────────────────────────────┐                 │
│ │     Aspect      │                              Details                              │                 │
│ ├─────────────────┼───────────────────────────────────────────────────────────────────┤                 │
│ │ File            │ crates/core_layout/src/lib.rs (~1400 lines, 38 tests)             │                 │
│ ├─────────────────┼───────────────────────────────────────────────────────────────────┤                 │
│ │ Tech Stack      │ Rust, serde, thiserror                                            │                 │
│ ├─────────────────┼───────────────────────────────────────────────────────────────────┤                 │
│ │ Previous Cycles │ Cycles 4-6 added encapsulation, focus policy, gap clamping        │                 │
│ ├─────────────────┼───────────────────────────────────────────────────────────────────┤                 │
│ │ Current State   │ Strong foundation, but 3 overflow risks + missing utility methods │                 │
│ └─────────────────┴───────────────────────────────────────────────────────────────────┘                 │
│ 1.3 Assumption Inventory                                                                                │
│ ┌────────────────────────────────────────────┬────────────┬───────────────────────────────────────────┐ │
│ │                 Assumption                 │   Status   │                   Notes                   │ │
│ ├────────────────────────────────────────────┼────────────┼───────────────────────────────────────────┤ │
│ │ Saturating arithmetic is preferred         │ [VERIFIED] │ Already used in total_width(), column_x() │ │
│ ├────────────────────────────────────────────┼────────────┼───────────────────────────────────────────┤ │
│ │ Debug assertions won't affect release perf │ [VERIFIED] │ Compiled out in release builds            │ │
│ ├────────────────────────────────────────────┼────────────┼───────────────────────────────────────────┤ │
│ │ Adding trait impls is non-breaking         │ [VERIFIED] │ Additive changes only                     │ │
│ ├────────────────────────────────────────────┼────────────┼───────────────────────────────────────────┤ │
│ │ f64 in Workspace prevents Eq derive        │ [VERIFIED] │ scroll_offset is f64                      │ │
│ └────────────────────────────────────────────┴────────────┴───────────────────────────────────────────┘ │
│ 1.4 Findings Summary (From Explore Agents)                                                              │
│                                                                                                         │
│ Critical (Must Fix):                                                                                    │
│ 1. Lines 610, 617, 620 - Unguarded i32 arithmetic in compute_placements()                               │
│ 2. Line 678 - Unguarded arithmetic in resize_focused_column()                                           │
│                                                                                                         │
│ High Value API Additions:                                                                               │
│ 1. find_window_location() - Returns (column_idx, window_idx) for a window ID                            │
│ 2. window_count() - Total windows across all columns                                                    │
│ 3. column() - Safe column access by index                                                               │
│ 4. PartialEq for Column (enables test assertions)                                                       │
│ 5. Debug assertions for invariant validation                                                            │
│                                                                                                         │
│ Test Coverage Gaps (35 identified, prioritizing 12):                                                    │
│ 1. Zero viewport dimensions                                                                             │
│ 2. Maximum column/window counts                                                                         │
│ 3. Operation combinations (resize→scroll, move→resize)                                                  │
│ 4. Focus clamping during navigation                                                                     │
│ 5. Property: invariants hold after any operation sequence                                               │
│                                                                                                         │
│ ---                                                                                                     │
│ PHASE 2: FINDINGS & FIXES                                                                               │
│                                                                                                         │
│ Finding #1: Unguarded Arithmetic in compute_placements() [CRITICAL]                                     │
│                                                                                                         │
│ Problem: Lines 610, 617, 620 can overflow with extreme values.                                          │
│                                                                                                         │
│ Current Code:                                                                                           │
│ let viewport_right = viewport_left + viewport.width;           // Line 610                              │
│ let col_strip_right = col_strip_x + column.width;              // Line 617                              │
│ let col_screen_x = col_strip_x - viewport_left + viewport.x;   // Line 620                              │
│                                                                                                         │
│ Fix:                                                                                                    │
│ let viewport_right = viewport_left.saturating_add(viewport.width);                                      │
│ let col_strip_right = col_strip_x.saturating_add(column.width);                                         │
│ let col_screen_x = col_strip_x.saturating_sub(viewport_left).saturating_add(viewport.x);                │
│                                                                                                         │
│ ---                                                                                                     │
│ Finding #2: Unguarded Arithmetic in resize_focused_column() [MEDIUM]                                    │
│                                                                                                         │
│ Problem: Line 678 can overflow with extreme delta values.                                               │
│                                                                                                         │
│ Current Code:                                                                                           │
│ let new_width = (column.width + delta).max(MIN_COLUMN_WIDTH);                                           │
│                                                                                                         │
│ Fix:                                                                                                    │
│ let new_width = column.width.saturating_add(delta).max(MIN_COLUMN_WIDTH);                               │
│                                                                                                         │
│ ---                                                                                                     │
│ Finding #3: Missing Utility Methods [HIGH VALUE]                                                        │
│                                                                                                         │
│ Add to Workspace impl:                                                                                  │
│                                                                                                         │
│ /// Find a window's location in the workspace.                                                          │
│ /// Returns (column_index, window_index_in_column) if found.                                            │
│ pub fn find_window_location(&self, window_id: WindowId) -> Option<(usize, usize)> {                     │
│     for (col_idx, column) in self.columns.iter().enumerate() {                                          │
│         if let Some(win_idx) = column.windows.iter().position(|&w| w == window_id) {                    │
│             return Some((col_idx, win_idx));                                                            │
│         }                                                                                               │
│     }                                                                                                   │
│     None                                                                                                │
│ }                                                                                                       │
│                                                                                                         │
│ /// Get total window count across all columns.                                                          │
│ pub fn window_count(&self) -> usize {                                                                   │
│     self.columns.iter().map(|c| c.len()).sum()                                                          │
│ }                                                                                                       │
│                                                                                                         │
│ /// Get a column by index (safe access).                                                                │
│ pub fn column(&self, index: usize) -> Option<&Column> {                                                 │
│     self.columns.get(index)                                                                             │
│ }                                                                                                       │
│                                                                                                         │
│ ---                                                                                                     │
│ Finding #4: Missing PartialEq for Column [MEDIUM]                                                       │
│                                                                                                         │
│ Problem: Cannot compare columns in tests without manual field checks.                                   │
│                                                                                                         │
│ Fix: Add derive:                                                                                        │
│ #[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]                                          │
│ pub struct Column {                                                                                     │
│                                                                                                         │
│ Note: Cannot derive Eq for Workspace due to f64 scroll_offset. Add manual PartialEq impl that ignores   │
│ scroll_offset or uses approximate comparison.                                                           │
│                                                                                                         │
│ ---                                                                                                     │
│ Finding #5: Missing Debug Assertions [MEDIUM]                                                           │
│                                                                                                         │
│ Add after critical operations:                                                                          │
│                                                                                                         │
│ // After insert_window (around line 330):                                                               │
│ debug_assert!(self.focused_column < self.columns.len(),                                                 │
│     "Invariant violation: focused_column out of bounds after insert");                                  │
│                                                                                                         │
│ // After remove_window (around line 403):                                                               │
│ debug_assert!(                                                                                          │
│     self.columns.is_empty() || self.focused_column < self.columns.len(),                                │
│     "Invariant violation: focused_column out of bounds after remove"                                    │
│ );                                                                                                      │
│                                                                                                         │
│ // After focus navigation methods:                                                                      │
│ debug_assert!(                                                                                          │
│     self.columns.is_empty() ||                                                                          │
│     (self.focused_column < self.columns.len() &&                                                        │
│      self.focused_window_in_column < self.columns[self.focused_column].len()),                          │
│     "Invariant violation: focus indices out of bounds"                                                  │
│ );                                                                                                      │
│                                                                                                         │
│ ---                                                                                                     │
│ Finding #6: Inconsistent Array Access [LOW]                                                             │
│                                                                                                         │
│ Problem: Lines 388, 414, 426 use direct indexing while line 442 uses .get().                            │
│                                                                                                         │
│ Fix: Standardize on pattern that relies on invariant maintenance (current code is safe due to           │
│ invariants, but add debug assertions as safety net).                                                    │
│                                                                                                         │
│ ---                                                                                                     │
│ New Tests (12 Priority Tests)                                                                           │
│ ┌─────┬────────────────────────────────────────────────┬─────────────────────────┐                      │
│ │  #  │                   Test Name                    │         Purpose         │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 1   │ test_compute_placements_zero_viewport_width    │ Zero viewport edge case │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 2   │ test_compute_placements_zero_viewport_height   │ Zero height edge case   │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 3   │ test_focus_navigation_clamps_to_shorter_column │ Focus clamping on nav   │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 4   │ test_resize_then_ensure_focused_visible        │ Operation combination   │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 5   │ test_move_column_then_resize                   │ Operation combination   │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 6   │ test_remove_reinsert_same_window_id            │ No stale state          │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 7   │ test_find_window_location                      │ New method              │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 8   │ test_window_count                              │ New method              │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 9   │ test_column_safe_access                        │ New method              │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 10  │ test_single_column_move_operations             │ Boundary case           │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 11  │ test_resize_on_empty_workspace                 │ Defensive programming   │                      │
│ ├─────┼────────────────────────────────────────────────┼─────────────────────────┤                      │
│ │ 12  │ test_invariants_after_complex_sequence         │ Property test           │                      │
│ └─────┴────────────────────────────────────────────────┴─────────────────────────┘                      │
│ ---                                                                                                     │
│ Files to Modify                                                                                         │
│ ┌───────────────────────────────┬─────────────────────────┐                                             │
│ │             File              │         Changes         │                                             │
│ ├───────────────────────────────┼─────────────────────────┤                                             │
│ │ crates/core_layout/src/lib.rs │ All fixes and additions │                                             │
│ └───────────────────────────────┴─────────────────────────┘                                             │
│ ---                                                                                                     │
│ Implementation Order                                                                                    │
│                                                                                                         │
│ Phase A: Critical Safety (Non-Breaking)                                                                 │
│                                                                                                         │
│ 1. Fix arithmetic overflow in compute_placements() (lines 610, 617, 620)                                │
│ 2. Fix arithmetic overflow in resize_focused_column() (line 678)                                        │
│                                                                                                         │
│ Phase B: API Additions (Non-Breaking)                                                                   │
│                                                                                                         │
│ 3. Add find_window_location() method                                                                    │
│ 4. Add window_count() method                                                                            │
│ 5. Add column() safe accessor method                                                                    │
│ 6. Add PartialEq, Eq derive to Column                                                                   │
│                                                                                                         │
│ Phase C: Debug Assertions                                                                               │
│                                                                                                         │
│ 7. Add debug assertions after insert_window                                                             │
│ 8. Add debug assertions after remove_window                                                             │
│ 9. Add debug assertions after focus navigation                                                          │
│                                                                                                         │
│ Phase D: Test Coverage                                                                                  │
│                                                                                                         │
│ 10. Add 12 new test cases                                                                               │
│                                                                                                         │
│ ---                                                                                                     │
│ Verification                                                                                            │
│                                                                                                         │
│ 1. cargo +stable-x86_64-pc-windows-gnu test -p openniri-core-layout - All 50 tests pass                 │
│ 2. cargo +stable-x86_64-pc-windows-gnu check -p openniri-daemon - Daemon compiles                       │
│ 3. cargo +stable-x86_64-pc-windows-gnu clippy -p openniri-core-layout - No warnings                     │
│                                                                                                         │
│ ---                                                                                                     │
│ PHASE 3: SELF-CORRECTION & QA                                                                           │
│                                                                                                         │
│ Breaking Change Assessment                                                                              │
│ ┌───────────────────────┬─────────────────┬──────────────────────────────────────┐                      │
│ │        Change         │ External Impact │             Test Impact              │                      │
│ ├───────────────────────┼─────────────────┼──────────────────────────────────────┤                      │
│ │ Saturating arithmetic │ NONE            │ Behavior unchanged for normal values │                      │
│ ├───────────────────────┼─────────────────┼──────────────────────────────────────┤                      │
│ │ New methods           │ NONE            │ Additive only                        │                      │
│ ├───────────────────────┼─────────────────┼──────────────────────────────────────┤                      │
│ │ PartialEq for Column  │ NONE            │ Additive trait                       │                      │
│ ├───────────────────────┼─────────────────┼──────────────────────────────────────┤                      │
│ │ Debug assertions      │ NONE            │ Only in debug builds                 │                      │
│ └───────────────────────┴─────────────────┴──────────────────────────────────────┘                      │
│ Risk Assessment: LOW - All changes are additive or internal safety improvements.                        │
│                                                                                                         │
│ Deferred Items                                                                                          │
│ ┌─────────────────────────────┬────────────────────────────────────────┐                                │
│ │            Item             │                 Reason                 │                                │
│ ├─────────────────────────────┼────────────────────────────────────────┤                                │
│ │ PartialEq for Workspace     │ f64 scroll_offset complicates equality │                                │
│ ├─────────────────────────────┼────────────────────────────────────────┤                                │
│ │ WorkspaceBuilder pattern    │ Low priority, current API sufficient   │                                │
│ ├─────────────────────────────┼────────────────────────────────────────┤                                │
│ │ move_window_to_column()     │ Needs more design consideration        │                                │
│ ├─────────────────────────────┼────────────────────────────────────────┤                                │
│ │ Thread safety documentation │ Not urgent for single-threaded use     │                                │
│ └─────────────────────────────┴────────────────────────────────────────┘                                │
│ ---                                                                                                     │
│ Summary                                                                                                 │
│                                                                                                         │
│ Cycle 7 focuses on defensive hardening and API completeness:                                            │
│                                                                                                         │
│ 1. Safety - Fix 4 arithmetic overflow risks with saturating ops                                         │
│ 2. Observability - Add debug assertions to catch invariant violations                                   │
│ 3. API - Add 3 high-value utility methods + PartialEq trait                                             │
│ 4. Testing - Add 12 targeted tests (38→50 total)                                                        │
│                                                                                                         │
│ Total: ~50 lines of new code, 12 new tests, 0 breaking changes                                          │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯

● I'll implement this plan for Code Review Cycle 7. Let me start by reading the current state of the file.

● Read 1 file (ctrl+o to expand)

● Now I have the full context. Let me implement the changes systematically according to the plan.

  Phase A: Critical Safety (Lines 610, 617, 620, 678)

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 3 lines, removed 3 lines
      607
      608          // Use rounding instead of truncation to prevent sub-pixel jitter
      609          let viewport_left = self.scroll_offset.round() as i32;
      610 -        let viewport_right = viewport_left + viewport.width;
      610 +        let viewport_right = viewport_left.saturating_add(viewport.width);
      611
      612          let mut current_x = outer_gap;
      613
      614          for (col_idx, column) in self.columns.iter().enumerate() {
      615              // Calculate column position in strip coordinates
      616              let col_strip_x = current_x;
      617 -            let col_strip_right = col_strip_x + column.width;
      617 +            let col_strip_right = col_strip_x.saturating_add(column.width);
      618
      619              // Transform to screen coordinates (relative to viewport)
      620 -            let col_screen_x = col_strip_x - viewport_left + viewport.x;
      620 +            let col_screen_x = col_strip_x.saturating_sub(viewport_left).saturating_add(v
          +iewport.x);
      621
      622              // Determine visibility
      623              let visibility = if col_strip_right <= viewport_left {

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 1 line, removed 1 line
      675      /// Resize the focused column by a delta amount.
      676      pub fn resize_focused_column(&mut self, delta: i32) {
      677          if let Some(column) = self.columns.get_mut(self.focused_column) {
      678 -            let new_width = (column.width + delta).max(MIN_COLUMN_WIDTH);
      678 +            let new_width = column.width.saturating_add(delta).max(MIN_COLUMN_WIDTH);
      679              column.width = new_width;
      680          }
      681      }

● Phase B: API Additions

  Now let me add PartialEq, Eq derive to Column:

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 1 line, removed 1 line
      111
      112  /// A column in the infinite strip.
      113  /// A column contains one or more vertically stacked windows.
      114 -#[derive(Debug, Clone, Serialize, Deserialize)]
      114 +#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
      115  pub struct Column {
      116      /// Width of the column in pixels.
      117      width: i32,

● Now let me add the three utility methods to the Workspace impl. I'll add them after columns():

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 21 lines
      474          &self.columns
      475      }
      476
      477 +    /// Get a column by index (safe access).
      478 +    pub fn column(&self, index: usize) -> Option<&Column> {
      479 +        self.columns.get(index)
      480 +    }
      481 +
      482 +    /// Find a window's location in the workspace.
      483 +    /// Returns (column_index, window_index_in_column) if found.
      484 +    pub fn find_window_location(&self, window_id: WindowId) -> Option<(usize, usize)> {
      485 +        for (col_idx, column) in self.columns.iter().enumerate() {
      486 +            if let Some(win_idx) = column.windows.iter().position(|&w| w == window_id) {
      487 +                return Some((col_idx, win_idx));
      488 +            }
      489 +        }
      490 +        None
      491 +    }
      492 +
      493 +    /// Get total window count across all columns.
      494 +    pub fn window_count(&self) -> usize {
      495 +        self.columns.iter().map(|c| c.len()).sum()
      496 +    }
      497 +
      498      /// Set focus to a specific column and window index with validation.
      499      ///
      500      /// # Errors

● Phase C: Debug Assertions

  Now let me add debug assertions. First after insert_window:

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 6 lines
      327              self.focused_column = insert_pos;
      328          }
      329          self.focused_window_in_column = 0;
      330 +
      331 +        debug_assert!(
      332 +            self.focused_column < self.columns.len(),
      333 +            "Invariant violation: focused_column out of bounds after insert"
      334 +        );
      335 +
      336          Ok(())
      337      }
      338

● Now add debug assertion after remove_window:

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 11 lines
      406                          // If removed_idx > focused_window_in_column, no adjustment neede
           d
      407                      }
      408                  }
      409 +
      410 +                debug_assert!(
      411 +                    self.columns.is_empty() || self.focused_column < self.columns.len(),
      412 +                    "Invariant violation: focused_column out of bounds after remove"
      413 +                );
      414 +                debug_assert!(
      415 +                    self.columns.is_empty()
      416 +                        || self.focused_window_in_column < self.columns[self.focused_colu
          +mn].len(),
      417 +                    "Invariant violation: focused_window_in_column out of bounds after re
          +move"
      418 +                );
      419 +
      420                  return Ok(());
      421              }
      422          }

● Now add debug assertions after focus_left:

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 7 lines
      433                  self.focused_window_in_column = col_len.saturating_sub(1);
      434              }
      435          }
      436 +
      437 +        debug_assert!(
      438 +            self.columns.is_empty()
      439 +                || (self.focused_column < self.columns.len()
      440 +                    && self.focused_window_in_column < self.columns[self.focused_column].
          +len()),
      441 +            "Invariant violation: focus indices out of bounds after focus_left"
      442 +        );
      443      }
      444
      445      /// Move focus to the column on the right.

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 7 lines
      452                  self.focused_window_in_column = col_len.saturating_sub(1);
      453              }
      454          }
      455 +
      456 +        debug_assert!(
      457 +            self.columns.is_empty()
      458 +                || (self.focused_column < self.columns.len()
      459 +                    && self.focused_window_in_column < self.columns[self.focused_column].
          +len()),
      460 +            "Invariant violation: focus indices out of bounds after focus_right"
      461 +        );
      462      }
      463
      464      /// Move focus to the window above in the current column.

● Phase D: Test Coverage

  Now let me add the 12 new tests. I'll add them at the end of the test module:

● Update(crates\core_layout\src\lib.rs)
  ⎿  Added 242 lines
      1447          let removed = col.remove_window(999);
      1448          assert_eq!(removed, None);
      1449      }
      1450 +
      1451 +    // ====== Tests added from code review (Cycle 7) ======
      1452 +
      1453 +    #[test]
      1454 +    fn test_compute_placements_zero_viewport_width() {
      1455 +        let mut ws = Workspace::with_gaps(10, 10);
      1456 +        ws.insert_window(1, Some(400)).unwrap();
      1457 +        ws.insert_window(2, Some(400)).unwrap();
      1458 +
      1459 +        // Zero width viewport - edge case
      1460 +        let viewport = Rect::new(0, 0, 0, 600);
      1461 +        let placements = ws.compute_placements(viewport);
      1462 +
      1463 +        // Should produce placements without panicking
      1464 +        assert_eq!(placements.len(), 2);
      1465 +        // All columns should be off-screen right (viewport has no width)
      1466 +        for p in &placements {
      1467 +            assert_eq!(p.visibility, Visibility::OffScreenRight);
      1468 +        }
      1469 +    }
      1470 +
      1471 +    #[test]
      1472 +    fn test_compute_placements_zero_viewport_height() {
      1473 +        let mut ws = Workspace::with_gaps(10, 10);
      1474 +        ws.insert_window(1, Some(400)).unwrap();
      1475 +        ws.insert_window_in_column(2, 0).unwrap();
      1476 +
      1477 +        // Zero height viewport - edge case
      1478 +        let viewport = Rect::new(0, 0, 500, 0);
      1479 +        let placements = ws.compute_placements(viewport);
      1480 +
      1481 +        // Should produce placements without panicking
      1482 +        assert_eq!(placements.len(), 2);
      1483 +        // All heights should be >= 0 (clamped)
      1484 +        for p in &placements {
      1485 +            assert!(p.rect.height >= 0, "Height was negative: {}", p.rect.height);
      1486 +        }
      1487 +    }
      1488 +
      1489 +    #[test]
      1490 +    fn test_focus_navigation_clamps_to_shorter_column() {
      1491 +        let mut ws = Workspace::new();
      1492 +        ws.insert_window(1, Some(400)).unwrap(); // Column 0: [1]
      1493 +        ws.insert_window(2, Some(400)).unwrap(); // Column 1: [2]
      1494 +        ws.insert_window_in_column(3, 0).unwrap(); // Column 0: [1, 3]
      1495 +        ws.insert_window_in_column(4, 0).unwrap(); // Column 0: [1, 3, 4]
      1496 +
      1497 +        // Focus on window 4 (column 0, index 2)
      1498 +        ws.test_set_focus_unchecked(0, 2);
      1499 +        assert_eq!(ws.focused_window(), Some(4));
      1500 +
      1501 +        // Move right to column 1 which only has 1 window
      1502 +        ws.focus_right();
      1503 +
      1504 +        // Focus should clamp to index 0 (the only window in column 1)
      1505 +        assert_eq!(ws.focused_column_index(), 1);
      1506 +        assert_eq!(ws.focused_window_index_in_column(), 0);
      1507 +        assert_eq!(ws.focused_window(), Some(2));
      1508 +    }
      1509 +
      1510 +    #[test]
      1511 +    fn test_resize_then_ensure_focused_visible() {
      1512 +        let mut ws = Workspace::with_gaps(10, 10);
      1513 +        ws.centering_mode = CenteringMode::JustInView;
      1514 +        ws.insert_window(1, Some(200)).unwrap();
      1515 +        ws.insert_window(2, Some(200)).unwrap();
      1516 +        ws.insert_window(3, Some(200)).unwrap();
      1517 +
      1518 +        // Focus column 2, resize it significantly
      1519 +        ws.test_set_focus_unchecked(2, 0);
      1520 +        ws.resize_focused_column(500); // Now 700px wide
      1521 +
      1522 +        // Ensure focused visible should adjust scroll
      1523 +        ws.ensure_focused_visible(500);
      1524 +
      1525 +        // Should have scrolled to bring the widened column into view
      1526 +        assert!(ws.scroll_offset() > 0.0);
      1527 +    }
      1528 +
      1529 +    #[test]
      1530 +    fn test_move_column_then_resize() {
      1531 +        let mut ws = Workspace::new();
      1532 +        ws.insert_window(1, Some(400)).unwrap();
      1533 +        ws.insert_window(2, Some(300)).unwrap();
      1534 +        ws.insert_window(3, Some(500)).unwrap();
      1535 +
      1536 +        // Focus column 1 (window 2, 300px)
      1537 +        ws.test_set_focus_unchecked(1, 0);
      1538 +        assert_eq!(ws.columns()[1].width(), 300);
      1539 +
      1540 +        // Move column left
      1541 +        ws.move_column_left();
      1542 +        assert_eq!(ws.focused_column_index(), 0);
      1543 +        assert_eq!(ws.columns()[0].width(), 300); // Column with window 2
      1544 +
      1545 +        // Resize the moved column
      1546 +        ws.resize_focused_column(100);
      1547 +        assert_eq!(ws.columns()[0].width(), 400);
      1548 +    }
      1549 +
      1550 +    #[test]
      1551 +    fn test_remove_reinsert_same_window_id() {
      1552 +        let mut ws = Workspace::new();
      1553 +        ws.insert_window(42, Some(400)).unwrap();
      1554 +        ws.insert_window(100, Some(300)).unwrap();
      1555 +
      1556 +        // Remove window 42
      1557 +        ws.remove_window(42).unwrap();
      1558 +        assert!(!ws.contains_window(42));
      1559 +
      1560 +        // Re-insert same ID should work now
      1561 +        ws.insert_window(42, Some(500)).unwrap();
      1562 +        assert!(ws.contains_window(42));
      1563 +        assert_eq!(ws.focused_window(), Some(42));
      1564 +    }
      1565 +
      1566 +    #[test]
      1567 +    fn test_find_window_location() {
      1568 +        let mut ws = Workspace::new();
      1569 +        ws.insert_window(1, Some(400)).unwrap(); // Column 0
      1570 +        ws.insert_window(2, Some(400)).unwrap(); // Column 1
      1571 +        ws.insert_window_in_column(3, 0).unwrap(); // Column 0, index 1
      1572 +        ws.insert_window_in_column(4, 1).unwrap(); // Column 1, index 1
      1573 +
      1574 +        assert_eq!(ws.find_window_location(1), Some((0, 0)));
      1575 +        assert_eq!(ws.find_window_location(2), Some((1, 0)));
      1576 +        assert_eq!(ws.find_window_location(3), Some((0, 1)));
      1577 +        assert_eq!(ws.find_window_location(4), Some((1, 1)));
      1578 +        assert_eq!(ws.find_window_location(999), None);
      1579 +    }
      1580 +
      1581 +    #[test]
      1582 +    fn test_window_count() {
      1583 +        let mut ws = Workspace::new();
      1584 +        assert_eq!(ws.window_count(), 0);
      1585 +
      1586 +        ws.insert_window(1, Some(400)).unwrap();
      1587 +        assert_eq!(ws.window_count(), 1);
      1588 +
      1589 +        ws.insert_window(2, Some(400)).unwrap();
      1590 +        assert_eq!(ws.window_count(), 2);
      1591 +
      1592 +        ws.insert_window_in_column(3, 0).unwrap();
      1593 +        ws.insert_window_in_column(4, 0).unwrap();
      1594 +        assert_eq!(ws.window_count(), 4);
      1595 +
      1596 +        ws.remove_window(2).unwrap();
      1597 +        assert_eq!(ws.window_count(), 3);
      1598 +    }
      1599 +
      1600 +    #[test]
      1601 +    fn test_column_safe_access() {
      1602 +        let mut ws = Workspace::new();
      1603 +        assert!(ws.column(0).is_none());
      1604 +
      1605 +        ws.insert_window(1, Some(400)).unwrap();
      1606 +        ws.insert_window(2, Some(500)).unwrap();
      1607 +
      1608 +        assert!(ws.column(0).is_some());
      1609 +        assert_eq!(ws.column(0).unwrap().width(), 400);
      1610 +        assert!(ws.column(1).is_some());
      1611 +        assert_eq!(ws.column(1).unwrap().width(), 500);
      1612 +        assert!(ws.column(2).is_none());
      1613 +        assert!(ws.column(100).is_none());
      1614 +    }
      1615 +
      1616 +    #[test]
      1617 +    fn test_single_column_move_operations() {
      1618 +        let mut ws = Workspace::new();
      1619 +        ws.insert_window(1, Some(400)).unwrap();
      1620 +
      1621 +        // Move operations on single column should do nothing
      1622 +        ws.move_column_left();
      1623 +        assert_eq!(ws.focused_column_index(), 0);
      1624 +        assert_eq!(ws.focused_window(), Some(1));
      1625 +
      1626 +        ws.move_column_right();
      1627 +        assert_eq!(ws.focused_column_index(), 0);
      1628 +        assert_eq!(ws.focused_window(), Some(1));
      1629 +    }
      1630 +
      1631 +    #[test]
      1632 +    fn test_resize_on_empty_workspace() {
      1633 +        let mut ws = Workspace::new();
      1634 +
      1635 +        // Resize on empty workspace should do nothing without panic
      1636 +        ws.resize_focused_column(100);
      1637 +        ws.resize_focused_column(-100);
      1638 +        ws.resize_focused_column(i32::MAX);
      1639 +        ws.resize_focused_column(i32::MIN);
      1640 +
      1641 +        assert!(ws.is_empty());
      1642 +    }
      1643 +
      1644 +    #[test]
      1645 +    fn test_invariants_after_complex_sequence() {
      1646 +        let mut ws = Workspace::with_gaps(10, 10);
      1647 +
      1648 +        // Insert several windows
      1649 +        ws.insert_window(1, Some(400)).unwrap();
      1650 +        ws.insert_window(2, Some(300)).unwrap();
      1651 +        ws.insert_window(3, Some(500)).unwrap();
      1652 +        ws.insert_window_in_column(4, 1).unwrap();
      1653 +        ws.insert_window_in_column(5, 1).unwrap();
      1654 +
      1655 +        // Complex sequence of operations
      1656 +        ws.focus_left();
      1657 +        ws.focus_down();
      1658 +        ws.move_column_right();
      1659 +        ws.resize_focused_column(100);
      1660 +        ws.focus_right();
      1661 +        ws.focus_up();
      1662 +        ws.remove_window(4).unwrap();
      1663 +        ws.focus_left();
      1664 +        ws.move_column_left();
      1665 +
      1666 +        // Verify invariants still hold
      1667 +        assert!(ws.focused_column < ws.columns.len());
      1668 +        assert!(ws.focused_window_in_column < ws.columns[ws.focused_column].len());
      1669 +
      1670 +        // No duplicate windows
      1671 +        let mut all_windows: Vec<WindowId> = ws.columns
      1672 +            .iter()
      1673 +            .flat_map(|c| c.windows().iter().copied())
      1674 +            .collect();
      1675 +        all_windows.sort();
      1676 +        let len_before = all_windows.len();
      1677 +        all_windows.dedup();
      1678 +        assert_eq!(all_windows.len(), len_before, "Duplicate windows found");
      1679 +    }
      1680 +
      1681 +    #[test]
      1682 +    fn test_column_partial_eq() {
      1683 +        let col1 = Column::new(1, 400);
      1684 +        let col2 = Column::new(1, 400);
      1685 +        let col3 = Column::new(2, 400);
      1686 +        let col4 = Column::new(1, 500);
      1687 +
      1688 +        assert_eq!(col1, col2);
      1689 +        assert_ne!(col1, col3); // Different window
      1690 +        assert_ne!(col1, col4); // Different width
      1691 +    }
      1692  }

● Now let's run the tests to verify everything works:

● Bash(cargo +stable-x86_64-pc-windows-gnu test -p openniri-core-layout 2>&1)
  ⎿  Shell ready. Type 'alias' to see available shortcuts.
        Compiling openniri-core-layout v0.1.0 (C:\dev\OpenNiri-Windows\crates\core_layout)
         Finished `test` profile [unoptimized + debuginfo] target(s) in 1.14s
     … +62 lines (ctrl+o to expand)
  ⎿  (timeout 3m)

● All 51 tests pass. Now let's verify the daemon compiles:

● Bash(cargo +stable-x86_64-pc-windows-gnu check -p openniri-daemon 2>&1)
  ⎿  Shell ready. Type 'alias' to see available shortcuts.
         Checking openniri-core-layout v0.1.0 (C:\dev\OpenNiri-Windows\crates\core_layout)
         Checking openniri-platform-win32 v0.1.0 (C:\dev\OpenNiri-Windows\crates\platform_win32)
     … +23 lines (ctrl+o to expand)

● The daemon compiles (with existing warnings unrelated to our changes). Now let's run clippy:

● Bash(cargo +stable-x86_64-pc-windows-gnu clippy -p openniri-core-layout 2>&1)
  ⎿  Shell ready. Type 'alias' to see available shortcuts.
         Checking serde v1.0.228
         Checking thiserror v2.0.18
     … +2 lines (ctrl+o to expand)
  ⎿  (timeout 3m)

● No clippy warnings. Let me provide a summary of the completed work:

  Cycle 7 Complete - Summary

  Phase A: Critical Safety Fixes ✓

  - Line 610: viewport_right now uses saturating_add
  - Line 617: col_strip_right now uses saturating_add
  - Line 620: col_screen_x now uses saturating_sub and saturating_add
  - Line 678: resize_focused_column() now uses saturating_add

  Phase B: API Additions ✓

  - Added PartialEq, Eq derive to Column struct
  - Added column(index: usize) -> Option<&Column> - safe column access
  - Added find_window_location(window_id) -> Option<(usize, usize)> - locate window by ID
  - Added window_count() -> usize - total windows across all columns

  Phase C: Debug Assertions ✓

  - After insert_window: validates focused_column in bounds
  - After remove_window: validates both focus indices
  - After focus_left / focus_right: validates focus indices

  Phase D: Test Coverage ✓

  Added 13 new tests (38 → 51 total):
  1. test_compute_placements_zero_viewport_width
  2. test_compute_placements_zero_viewport_height
  3. test_focus_navigation_clamps_to_shorter_column
  4. test_resize_then_ensure_focused_visible
  5. test_move_column_then_resize
  6. test_remove_reinsert_same_window_id
  7. test_find_window_location
  8. test_window_count
  9. test_column_safe_access
  10. test_single_column_move_operations
  11. test_resize_on_empty_workspace
  12. test_invariants_after_complex_sequence
  13. test_column_partial_eq

  Verification ✓

  - All 51 tests pass
  - Daemon compiles successfully
  - No clippy warnings

✻ Sautéed for 3m 16s

───────────────────────────────────────────────────────────────────────────────────────────────────────────
❯ commit this
───────────────────────────────────────────────────────────────────────────────────────────────────────────
  ⏵⏵ bypass permissions on (shift+tab to cycle)
